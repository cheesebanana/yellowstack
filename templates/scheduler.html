<!-- templates/scheduler.html -->
{% extends "layout.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Script Scheduler</h1>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addScheduleModal">
                <i class="ti ti-calendar-plus me-1"></i> Add New Schedule
            </button>
        </div>
        
        <div id="schedules-list">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading schedules...</p>
        </div>
    </div>
</div>

<!-- Modal for adding new schedule -->
<div class="modal fade" id="addScheduleModal" tabindex="-1" aria-labelledby="addScheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addScheduleModalLabel">Add New Schedule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addScheduleForm">
                    <input type="hidden" id="scheduleId">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="scriptSelect" class="form-label">Script</label>
                            <select class="form-select" id="scriptSelect" required>
                                <option value="">Select script</option>
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="profileSelect" class="form-label">AWS Profile</label>
                            <select class="form-select" id="profileSelect" required>
                                <option value="">Select profile</option>
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Schedule Type</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="dailySchedule">
                                    <label class="form-check-label" for="dailySchedule">
                                        Run daily at
                                    </label>
                                    <select class="form-select mt-2" id="dailyTime" disabled>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="intervalSchedule">
                                    <label class="form-check-label" for="intervalSchedule">
                                        Run every
                                    </label>
                                    <div class="input-group mt-2">
                                        <select class="form-select" id="intervalHours" disabled>
                                        </select>
                                        <span class="input-group-text">hours</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="scheduleError" class="invalid-feedback d-block" style="display: none !important;">
                            Please select at least one schedule type
                        </div>
                    </div>
                    
                    <!-- Script parameters section -->
                    <div id="scriptParametersContainer" class="mb-3" style="display: none;">
                        <h6 class="mb-3 border-bottom pb-2">Script Parameters</h6>
                        <div id="parameterInputsContainer">
                            <!-- Parameter inputs will be added here dynamically -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveScheduleBtn">Save Schedule</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for viewing schedule details -->
<div class="modal fade" id="viewScheduleModal" tabindex="-1" aria-labelledby="viewScheduleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewScheduleModalLabel">Schedule Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3" id="scheduleDetailsLoading">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Loading schedule details...</p>
                </div>
                <div id="scheduleDetailsContent" style="display: none;">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-sm">
                                <tr>
                                    <th>Script:</th>
                                    <td id="detailScriptName">-</td>
                                </tr>
                                <tr>
                                    <th>AWS Profile:</th>
                                    <td id="detailProfileName">-</td>
                                </tr>
                                <tr>
                                    <th>Created By:</th>
                                    <td id="detailUsername">-</td>
                                </tr>
                                <tr>
                                    <th>Created At:</th>
                                    <td id="detailCreatedAt">-</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-sm">
                                <tr>
                                    <th>Schedule Type:</th>
                                    <td id="detailScheduleType">-</td>
                                </tr>
                                <tr>
                                    <th>Schedule Value:</th>
                                    <td id="detailScheduleValue">-</td>
                                </tr>
                                <tr>
                                    <th>Status:</th>
                                    <td id="detailStatus">-</td>
                                </tr>
                                <tr>
                                    <th>Next Run:</th>
                                    <td id="detailNextRun">-</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    <div id="detailParametersSection" class="mt-3" style="display: none;">
                        <h6 class="mb-2 border-bottom pb-2">Script Parameters</h6>
                        <div id="detailParameters">
                            <!-- Parameters will be displayed here -->
                        </div>
                    </div>
                    
                    <div id="detailRunHistorySection" class="mt-4">
                        <h6 class="mb-2 border-bottom pb-2">Recent Executions</h6>
                        <div id="detailRunHistory">
                            <p class="text-muted">Loading execution history...</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="runNowBtn">
                    <i class="ti ti-player-play me-1"></i>Run Now
                </button>
                <button type="button" class="btn btn-warning" id="editScheduleBtn">
                    <i class="ti ti-edit me-1"></i>Edit
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Custom confirmation modal for delete operations -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel">Delete Confirmation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="deleteItemId">
                <p id="deleteConfirmMessage">Are you sure you want to delete this item?</p>
                <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="ti ti-trash me-1"></i>Delete
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block head %}
<style>
    /* Style for schedule type labels */
    .schedule-type-badge {
        font-size: 0.85rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
    }
    
    .schedule-type-badge.daily {
        background-color: #e3f2fd;
        color: #206bc4;
        border: 1px solid #90caf9;
    }
    
    .schedule-type-badge.interval {
        background-color: #e8f5e9;
        color: #2fb344;
        border: 1px solid #a5d6a7;
    }
    
    /* Next run time styling */
    .next-run {
        font-size: 0.85rem;
        color: #666;
    }
    
    .next-run.approaching {
        color: #d63939;
        font-weight: 500;
    }
    
    /* Toggle switch enhancements */
    .form-switch .form-check-input {
        width: 2.5em;
        height: 1.25em;
    }
    
    .form-switch .form-check-input:checked {
        background-color: #2fb344;
        border-color: #2fb344;
    }
    
    /* Status badge styling */
    .badge.enabled {
        background-color: #d1e7dd;
        color: #146c43;
    }
    
    .badge.disabled {
        background-color: #f8d7da;
        color: #b02a37;
    }
    
    /* Schedule card styles */
    .schedule-card {
        transition: all 0.2s ease;
        border-radius: 8px;
        overflow: hidden;
    }
    
    /* Actions hover effect */
    .schedule-actions .btn {
        opacity: 0.85;
        transition: all 0.2s ease;
    }
    
    .schedule-actions .btn:hover {
        opacity: 1;
        transform: scale(1.05);
    }
    
    /* Script and profile names */
    .script-name {
        font-weight: 500;
        color: #206bc4;
    }
    
    .profile-name {
        font-size: 0.9rem;
        color: #555;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // =======================================
    // GLOBAL VARIABLES 
    // =======================================
    let currentScheduleId = null;
    let scriptParameters = {};
    
    // =======================================
    // HELPER FUNCTIONS
    // =======================================
    
    /**
     * Format a daily schedule time (HH:MM) to a more readable format
     */
    function formatDailyTime(timeStr) {
        if (!timeStr) return '-';
        
        try {
            const [hours, minutes] = timeStr.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const hour12 = hour % 12 || 12;
            
            return `${hour12}:${minutes} ${ampm}`;
        } catch (e) {
            console.error('Error formatting time:', e);
            return timeStr;
        }
    }
    
    /**
     * Format an interval schedule to readable format
     */
    function formatInterval(interval) {
        if (!interval) return '-';
        
        // Handle hour-based intervals
        const hours = parseInt(interval);
        if (!isNaN(hours)) {
            if (hours === 1) return 'Every hour';
            if (hours === 24) return 'Every day';
            return `Every ${hours} hours`;
        }
        
        // Fallback for any other format
        return interval;
    }
    
    /**
     * Format the next run time
     */
    function formatNextRun(nextRunStr) {
        if (!nextRunStr) return 'Not scheduled';
        
        try {
            const nextRun = new Date(nextRunStr);
            const now = new Date();
            
            const diffMs = nextRun - now;
            const diffMin = Math.floor(diffMs / 60000);
            
            if (diffMin < 0) {
                // If time passed but schedule is daily, show next run in 24 hours
                const tomorrow = new Date(now);
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(nextRun.getHours(), nextRun.getMinutes(), 0, 0);
                
                const tomorrowDiffMs = tomorrow - now;
                const tomorrowDiffMin = Math.floor(tomorrowDiffMs / 60000);
                
                if (tomorrowDiffMin > 0) {
                    const tomorrowDiffHours = Math.floor(tomorrowDiffMin / 60);
                    if (tomorrowDiffHours < 24) {
                        return `In ${tomorrowDiffHours} hour${tomorrowDiffHours === 1 ? '' : 's'}`;
                    }
                }
                
                return 'Overdue';
            }
            
            if (diffMin < 60) {
                return `In ${diffMin} minute${diffMin === 1 ? '' : 's'}`;
            }
            
            const diffHours = Math.floor(diffMin / 60);
            if (diffHours < 24) {
                return `In ${diffHours} hour${diffHours === 1 ? '' : 's'}`;
            }
            
            const diffDays = Math.floor(diffHours / 24);
            if (diffDays < 7) {
                return `In ${diffDays} day${diffDays === 1 ? '' : 's'}`;
            }
            
            return nextRun.toLocaleString();
        } catch (e) {
            console.error('Error formatting next run time:', e);
            return nextRunStr;
        }
    }
    
    /**
     * Format schedule type and value for display
     */
    function formatScheduleType(type, value) {
        if (type === 'daily') {
            return `<span class="schedule-type-badge daily">
                      <i class="ti ti-clock me-1"></i>Daily at ${formatDailyTime(value)}
                    </span>`;
        } else if (type === 'interval') {
            return `<span class="schedule-type-badge interval">
                      <i class="ti ti-refresh me-1"></i>${formatInterval(value)}
                    </span>`;
        }
        
        return '-';
    }
    
    /**
     * Check if next run time is approaching (within 1 hour)
     */
    function isNextRunApproaching(nextRunStr) {
        if (!nextRunStr) return false;
        
        try {
            const nextRun = new Date(nextRunStr);
            const now = new Date();
            
            const diffMs = nextRun - now;
            const diffMin = Math.floor(diffMs / 60000);
            
            return diffMin > 0 && diffMin < 60;
        } catch (e) {
            return false;
        }
    }
    
    /**
     * Update the status of a schedule in the UI
     */
    function updateScheduleStatus(scheduleId, enabled) {
        const scheduleCard = document.querySelector(`.schedule-card[data-schedule-id="${scheduleId}"]`);
        if (!scheduleCard) return;
        
        const statusBadge = scheduleCard.querySelector('.status-badge');
        if (statusBadge) {
            statusBadge.className = `badge ${enabled ? 'enabled' : 'disabled'} status-badge`;
            statusBadge.innerHTML = enabled ? 'Enabled' : 'Disabled';
        }
        
        const toggleCheckbox = scheduleCard.querySelector('.schedule-toggle');
        if (toggleCheckbox) {
            toggleCheckbox.checked = enabled;
        }
    }
    
    // =======================================
    // DATA LOADING FUNCTIONS 
    // =======================================
    
    /**
     * Load scripts for the dropdown
     */
    function loadScripts() {
        fetch('/api/scripts')
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    showToast(data.message || 'Error loading scripts', 'error');
                    return;
                }
                
                const scriptSelect = document.getElementById('scriptSelect');
                
                // Clear existing options except the first one
                while (scriptSelect.options.length > 1) {
                    scriptSelect.remove(1);
                }
                
                // Add scripts to the dropdown
                data.scripts.forEach(script => {
                    const option = document.createElement('option');
                    option.value = script.id;
                    option.textContent = script.name;
                    option.dataset.parameters = script.parameters || '';
                    
                    scriptSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading scripts:', error);
                showToast('Error loading scripts', 'error');
            });
    }
    
    /**
     * Load AWS profiles for the dropdown
     */
    function loadAwsProfiles() {
        fetch('/api/aws_profiles')
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    showToast(data.message || 'Error loading AWS profiles', 'error');
                    return;
                }
                
                const profileSelect = document.getElementById('profileSelect');
                
                // Clear existing options except the first one
                while (profileSelect.options.length > 1) {
                    profileSelect.remove(1);
                }
                
                // Add profiles to the dropdown
                data.profiles.forEach(profile => {
                    const option = document.createElement('option');
                    option.value = profile.id;
                    option.textContent = profile.name;
                    option.selected = profile.is_default === 1;
                    
                    profileSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading AWS profiles:', error);
                showToast('Error loading AWS profiles', 'error');
            });
    }
    
    /**
     * Load schedules
     */
     function loadSchedules() {
        const container = document.getElementById('schedules-list');
        container.innerHTML = `
            <div class="d-flex justify-content-center my-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span class="ms-2">Loading schedules...</span>
            </div>
        `;
        
        // Always include disabled schedules
        const queryParams = new URLSearchParams();
        queryParams.append('include_disabled', 'true');
        
        fetch(`/api/schedules?${queryParams.toString()}`)
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    showToast(data.message || 'Error loading schedules', 'error');
                    container.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="ti ti-alert-circle me-2"></i>Error loading schedules
                        </div>
                    `;
                    return;
                }
                
                let schedules = data.schedules;
                
                // Display schedules
                if (schedules.length === 0) {
                    container.innerHTML = `
                        <div class="alert alert-info">
                            <i class="ti ti-info-circle me-2"></i>No schedules found. Add one to get started!
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = '';
                
                schedules.forEach(schedule => {
                    // Create card for each schedule
                    const card = document.createElement('div');
                    card.className = 'card schedule-card mb-3';
                    card.dataset.scheduleId = schedule.id;
                    
                    // Format next run time
                    const nextRunFormatted = formatNextRun(schedule.next_run);
                    const nextRunClass = isNextRunApproaching(schedule.next_run) ? 'approaching' : '';
                    
                    card.innerHTML = `
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-7">
                                    <div class="d-flex align-items-center mb-2">
                                        <h5 class="mb-0 me-2 script-name">${schedule.script_name}</h5>
                                        <span class="badge ${schedule.enabled ? 'enabled' : 'disabled'} status-badge">
                                            ${schedule.enabled ? 'Enabled' : 'Disabled'}
                                        </span>
                                    </div>
                                    <div class="profile-name mb-2">
                                        <i class="ti ti-cloud me-1"></i>${schedule.profile_name}
                                    </div>
                                    <div class="mb-3">
                                        ${formatScheduleType(schedule.schedule_type, schedule.schedule_value)}
                                    </div>
                                    <div class="next-run ${nextRunClass}">
                                        <i class="ti ti-calendar-event me-1"></i>Next run: ${nextRunFormatted}
                                    </div>
                                </div>
                                <div class="col-md-5">
                                    <div class="d-flex flex-column align-items-end h-100">
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input schedule-toggle" type="checkbox" 
                                                ${schedule.enabled ? 'checked' : ''} data-schedule-id="${schedule.id}">
                                            <label class="form-check-label">Enabled</label>
                                        </div>
                                        <div class="schedule-actions mt-auto">
                                            <button class="btn btn-sm btn-outline-primary view-schedule me-1" 
                                                    data-schedule-id="${schedule.id}">
                                                <i class="ti ti-eye me-1"></i>View
                                            </button>
                                            <button class="btn btn-sm btn-outline-warning edit-schedule me-1" 
                                                    data-schedule-id="${schedule.id}">
                                                <i class="ti ti-edit me-1"></i>Edit
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger delete-schedule" 
                                                    data-schedule-id="${schedule.id}">
                                                <i class="ti ti-trash me-1"></i>Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(card);
                });
                
                // Add event listeners to the newly created elements
                addEventListeners();
            })
            .catch(error => {
                console.error('Error loading schedules:', error);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="ti ti-alert-circle me-2"></i>Error loading schedules: ${error.message}
                    </div>
                `;
            });
    }
    
    /**
     * Add event listeners to schedule cards
     */
    function addEventListeners() {
        // Toggle schedule enabled/disabled
        document.querySelectorAll('.schedule-toggle').forEach(toggle => {
            toggle.addEventListener('change', function() {
                const scheduleId = this.dataset.scheduleId;
                const enabled = this.checked;
                
                toggleScheduleStatus(scheduleId, enabled);
            });
        });
        
        // View schedule details
        document.querySelectorAll('.view-schedule').forEach(button => {
            button.addEventListener('click', function() {
                const scheduleId = this.dataset.scheduleId;
                viewScheduleDetails(scheduleId);
            });
        });
        
        // Edit schedule
        document.querySelectorAll('.edit-schedule').forEach(button => {
            button.addEventListener('click', function() {
                const scheduleId = this.dataset.scheduleId;
                
                // Get schedule data and open edit form
                fetch(`/api/schedules/${scheduleId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        editSchedule(data.schedule);
                    } else {
                        showToast(data.message || 'Error loading schedule', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error loading schedule:', error);
                    showToast('Error loading schedule', 'error');
                });
            });
        });
        
        // Delete schedule - using custom modal
        document.querySelectorAll('.delete-schedule').forEach(button => {
            button.addEventListener('click', function() {
                const scheduleId = this.dataset.scheduleId;
                deleteSchedule(scheduleId);
            });
        });
    }
    
    /**
     * Setup parameter inputs based on the selected script
     */
    function setupParameterInputs(scriptId) {
        const scriptSelect = document.getElementById('scriptSelect');
        const selectedOption = scriptSelect.options[scriptSelect.selectedIndex];
        
        const container = document.getElementById('parameterInputsContainer');
        container.innerHTML = '';
        
        const parametersContainer = document.getElementById('scriptParametersContainer');
        
        if (!selectedOption || !selectedOption.dataset.parameters) {
            parametersContainer.style.display = 'none';
            return;
        }
        
        try {
            const parameters = JSON.parse(selectedOption.dataset.parameters);
            
            if (!parameters || parameters.length === 0) {
                parametersContainer.style.display = 'none';
                return;
            }
            
            parameters.forEach(param => {
                const inputGroup = document.createElement('div');
                inputGroup.className = 'mb-3';
                inputGroup.innerHTML = `
                    <label class="form-label">${param.name}</label>
                    <input type="text" class="form-control" name="param-${param.name}" 
                           value="${param.default || ''}" placeholder="Enter value">
                `;
                container.appendChild(inputGroup);
            });
            
            // Show parameters section
            parametersContainer.style.display = 'block';
        } catch (e) {
            console.error('Error parsing parameters:', e);
            parametersContainer.style.display = 'none';
        }
    }
    
    /**
     * Load the schedule details for viewing
     */
    function viewScheduleDetails(scheduleId) {
        // Show the modal and loading state
        const modal = new bootstrap.Modal(document.getElementById('viewScheduleModal'));
        modal.show();
        
        document.getElementById('scheduleDetailsLoading').style.display = 'block';
        document.getElementById('scheduleDetailsContent').style.display = 'none';
        
        // Set the current schedule ID for the Run Now button
        currentScheduleId = scheduleId;
        
        // Fetch schedule details
        fetch(`/api/schedules/${scheduleId}`)
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    showToast(data.message || 'Error loading schedule details', 'error');
                    return;
                }
                
                const schedule = data.schedule;
                
                // Fill in the details
                document.getElementById('detailScriptName').textContent = schedule.script_name;
                document.getElementById('detailProfileName').textContent = schedule.profile_name;
                document.getElementById('detailUsername').textContent = schedule.username;
                document.getElementById('detailCreatedAt').textContent = new Date(schedule.created_at).toLocaleString();
                
                // Format schedule type and value
                let scheduleTypeText = 'Unknown';
                let scheduleValueText = '-';
                
                if (schedule.schedule_type === 'daily') {
                    scheduleTypeText = 'Daily';
                    scheduleValueText = formatDailyTime(schedule.schedule_value);
                } else if (schedule.schedule_type === 'interval') {
                    scheduleTypeText = 'Interval';
                    scheduleValueText = formatInterval(schedule.schedule_value);
                }
                
                document.getElementById('detailScheduleType').textContent = scheduleTypeText;
                document.getElementById('detailScheduleValue').textContent = scheduleValueText;
                
                // Status
                document.getElementById('detailStatus').innerHTML = `
                    <span class="badge ${schedule.enabled ? 'enabled' : 'disabled'}">
                        ${schedule.enabled ? 'Enabled' : 'Disabled'}
                    </span>
                `;
                
                // Next run
                document.getElementById('detailNextRun').textContent = 
                    schedule.next_run ? new Date(schedule.next_run).toLocaleString() : 'Not scheduled';
                
                // Parameters
                const parametersSection = document.getElementById('detailParametersSection');
                const parametersContainer = document.getElementById('detailParameters');
                
                if (schedule.parameters && Object.keys(schedule.parameters).length > 0) {
                    parametersContainer.innerHTML = '';
                    
                    // Create a table for parameters
                    const table = document.createElement('table');
                    table.className = 'table table-sm';
                    
                    const tbody = document.createElement('tbody');
                    
                    for (const [key, value] of Object.entries(schedule.parameters)) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <th>${key}</th>
                            <td>${value || '<em>empty</em>'}</td>
                        `;
                        tbody.appendChild(row);
                    }
                    
                    table.appendChild(tbody);
                    parametersContainer.appendChild(table);
                    parametersSection.style.display = 'block';
                } else {
                    parametersSection.style.display = 'none';
                }
                
                // Hide execution history for now
                document.getElementById('detailRunHistorySection').style.display = 'none';
                
                // Show the content
                document.getElementById('scheduleDetailsLoading').style.display = 'none';
                document.getElementById('scheduleDetailsContent').style.display = 'block';
                
                // Set the edit button to open the edit modal
                document.getElementById('editScheduleBtn').onclick = function() {
                    modal.hide();
                    editSchedule(schedule);
                };
            })
            .catch(error => {
                console.error('Error loading schedule details:', error);
                showToast('Error loading schedule details', 'error');
                
                // Hide loading, show error in content area
                document.getElementById('scheduleDetailsLoading').style.display = 'none';
                document.getElementById('scheduleDetailsContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="ti ti-alert-circle me-2"></i>Error loading schedule details: ${error.message}
                    </div>
                `;
                document.getElementById('scheduleDetailsContent').style.display = 'block';
            });
    }
    
    /**
     * Populate the form for editing a schedule
     */
    function editSchedule(schedule) {
        // Set the current schedule ID for the form
        document.getElementById('scheduleId').value = schedule.id;
        
        // Update the modal title
        document.getElementById('addScheduleModalLabel').textContent = 'Edit Schedule';
        
        // Select the script and profile
        document.getElementById('scriptSelect').value = schedule.script_id;
        document.getElementById('profileSelect').value = schedule.profile_id;
        
        // Set schedule type and value (ensuring mutual exclusivity)
        // Reset both checkboxes first
        document.getElementById('dailySchedule').checked = false;
        document.getElementById('intervalSchedule').checked = false;
        document.getElementById('dailyTime').disabled = true;
        document.getElementById('intervalHours').disabled = true;

        // Now set the appropriate one based on schedule type
        if (schedule.schedule_type === 'daily') {
            document.getElementById('dailySchedule').checked = true;
            document.getElementById('dailyTime').disabled = false;
            document.getElementById('dailyTime').value = schedule.schedule_value;

            // Make sure the other is unchecked and its dropdown disabled
            document.getElementById('intervalSchedule').checked = false;
            document.getElementById('intervalHours').disabled = true;
        } else if (schedule.schedule_type === 'interval') {
            document.getElementById('intervalSchedule').checked = true;
            document.getElementById('intervalHours').disabled = false;
            document.getElementById('intervalHours').value = schedule.schedule_value;

            // Make sure the other is unchecked and its dropdown disabled
            document.getElementById('dailySchedule').checked = false;
            document.getElementById('dailyTime').disabled = true;
        }
        
        // Setup parameters
        setupParameterInputs(schedule.script_id);
        
        // If there are saved parameters, fill them in
        if (schedule.parameters) {
            setTimeout(() => {
                for (const [key, value] of Object.entries(schedule.parameters)) {
                    const input = document.querySelector(`input[name="param-${key}"]`);
                    if (input) {
                        input.value = value || '';
                    }
                }
            }, 100);
        }
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('addScheduleModal'));
        modal.show();
    }
    
    // =======================================
    // API INTERACTION FUNCTIONS 
    // =======================================
    
    /**
     * Toggle a schedule's enabled/disabled status
     */
     function toggleScheduleStatus(scheduleId, enabled) {
        fetch(`/api/schedules/${scheduleId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                enabled: enabled
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the UI without reloading
                updateScheduleStatus(scheduleId, enabled);
                showToast(`Schedule ${enabled ? 'enabled' : 'disabled'} successfully`, 'success');
            } else {
                // Revert the toggle in the UI
                updateScheduleStatus(scheduleId, !enabled);
                showToast(data.message || 'Error toggling schedule status', 'error');
            }
        })
        .catch(error => {
            console.error('Error toggling schedule status:', error);
            // Revert the toggle in the UI
            updateScheduleStatus(scheduleId, !enabled);
            showToast('Error toggling schedule status', 'error');
        });
    }
    
    /**
     * Run a schedule immediately
     */
    function runScheduleNow(scheduleId) {
        fetch(`/api/schedules/${scheduleId}/run`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Schedule execution started', 'success');
                if (data.execution_id) {
                    // Navigate to execution details page
                    window.location.href = `/view_execution/${data.execution_id}`;
                }
            } else {
                showToast(data.message || 'Error running schedule', 'error');
            }
        })
        .catch(error => {
            console.error('Error running schedule:', error);
            showToast('Error running schedule', 'error');
        });
    }
    
    /**
     * Delete a schedule with custom modal confirmation
     */
    function deleteSchedule(scheduleId) {
        // Set up the confirmation dialog
        document.getElementById('deleteItemId').value = scheduleId;
        document.getElementById('deleteConfirmMessage').textContent = 'Are you sure you want to delete this schedule?';
        
        // Show the modal
        const confirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
        confirmModal.show();
        
        // Set up confirmation button handler
        document.getElementById('confirmDeleteBtn').onclick = function() {
            // Hide the modal
            confirmModal.hide();
            
            // Show loading indicator
            const container = document.getElementById('schedules-list');
            if (container) {
                container.innerHTML = `
                    <div class="d-flex justify-content-center my-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Deleting...</span>
                        </div>
                        <span class="ms-2">Deleting schedule...</span>
                    </div>
                `;
            }
            
            // Send delete request
            fetch(`/api/schedules/${scheduleId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Reload schedules list
                    loadSchedules();
                    showToast('Schedule deleted successfully', 'success');
                } else {
                    showToast(data.message || 'Error deleting schedule', 'error');
                    loadSchedules(); // Reload anyway
                }
            })
            .catch(error => {
                console.error('Error deleting schedule:', error);
                showToast('Error deleting schedule', 'error');
                loadSchedules();
            });
        };
    }
    
    /**
     * Collect parameter values for a schedule
     */
    function collectParameterValues() {
        const params = {};
        
        document.querySelectorAll('#parameterInputsContainer input').forEach(input => {
            if (input.name && input.name.startsWith('param-')) {
                const paramName = input.name.substring(6); // Remove 'param-' prefix
                params[paramName] = input.value;
            }
        });
        
        return params;
    }
    
    /**
     * Save a new or edited schedule
     */
    function saveSchedule() {
        // Get form values
        const scheduleId = document.getElementById('scheduleId').value;
        const scriptId = document.getElementById('scriptSelect').value;
        const profileId = document.getElementById('profileSelect').value;
        
        const dailySchedule = document.getElementById('dailySchedule').checked;
        const intervalSchedule = document.getElementById('intervalSchedule').checked;
        
        // Validate inputs
        if (!scriptId) {
            showToast('Please select a script', 'warning');
            return;
        }
        
        if (!profileId) {
            showToast('Please select an AWS profile', 'warning');
            return;
        }
        
        if (!dailySchedule && !intervalSchedule) {
            document.getElementById('scheduleError').style.display = 'block';
            return;
        }
        
        document.getElementById('scheduleError').style.display = 'none';
        
        // Determine schedule type and value
        let scheduleType, scheduleValue;
        
        if (dailySchedule) {
            scheduleType = 'daily';
            scheduleValue = document.getElementById('dailyTime').value;
        } else if (intervalSchedule) {
            scheduleType = 'interval';
            scheduleValue = document.getElementById('intervalHours').value;
        }
        
        // Collect parameters
        const parameters = collectParameterValues();
        
        // Disable save button
        const saveBtn = document.getElementById('saveScheduleBtn');
        const origBtnText = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="ti ti-loader ti-spin me-1"></i>Saving...';
        
        // Determine if this is a new schedule or an edit
        const isEdit = scheduleId !== '';
        
        // API endpoint and method
        const url = isEdit ? `/api/schedules/${scheduleId}` : '/api/schedules';
        const method = isEdit ? 'PUT' : 'POST';
        
        // Prepare request data
        const requestData = {
            script_id: scriptId,
            profile_id: profileId,
            schedule_type: scheduleType,
            schedule_value: scheduleValue,
            parameters: parameters
        };
        
        // For edit requests, add enabled flag
        if (isEdit) {
            requestData.enabled = true;
        }
        
        // Send API request
        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            // Re-enable save button
            saveBtn.disabled = false;
            saveBtn.innerHTML = origBtnText;
            
            if (data.success) {
                // Hide modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('addScheduleModal'));
                modal.hide();
                
                // Reset form
                resetScheduleForm();
                
                // Reload schedules
                loadSchedules();
                
                showToast(`Schedule ${isEdit ? 'updated' : 'created'} successfully`, 'success');
            } else {
                showToast(data.message || `Error ${isEdit ? 'updating' : 'creating'} schedule`, 'error');
            }
        })
        .catch(error => {
            console.error(`Error ${isEdit ? 'updating' : 'creating'} schedule:`, error);
            
            // Re-enable save button
            saveBtn.disabled = false;
            saveBtn.innerHTML = origBtnText;
            
            showToast(`Error ${isEdit ? 'updating' : 'creating'} schedule`, 'error');
        });
    }
    
    /**
     * Reset the schedule form
     */
    function resetScheduleForm() {
        document.getElementById('scheduleId').value = '';
        document.getElementById('scriptSelect').value = '';
        document.getElementById('profileSelect').value = '';
        
        document.getElementById('dailySchedule').checked = false;
        document.getElementById('intervalSchedule').checked = false;
        
        document.getElementById('dailyTime').disabled = true;
        document.getElementById('intervalHours').disabled = true;
        
        document.getElementById('scheduleError').style.display = 'none';
        
        document.getElementById('scriptParametersContainer').style.display = 'none';
        document.getElementById('parameterInputsContainer').innerHTML = '';
        
        document.getElementById('addScheduleModalLabel').textContent = 'Add New Schedule';
    }
    
    // =======================================
    // INITIALIZE PAGE
    // =======================================
    
    document.addEventListener('DOMContentLoaded', function() {
        // Check if showToast exists, if not, provide a fallback
        if (typeof showToast !== 'function') {
            console.warn('showToast function not found. Creating fallback...');
            window.showToast = function(message, type = 'info') {
                console.log(`Toast (${type}): ${message}`);
                alert(message);
            };
        }
        
        // Load initial data
        loadScripts();
        loadAwsProfiles();
        loadSchedules();

        // Generation time option
        populateTimeOptions();
        populateIntervalOptions();
        
        // Schedule type checkboxes - make them mutually exclusive
        document.getElementById('dailySchedule').addEventListener('change', function() {
            // If this checkbox is now checked
            if (this.checked) {
                // Enable its dropdown
                document.getElementById('dailyTime').disabled = false;

                // Uncheck the other option
                document.getElementById('intervalSchedule').checked = false;
                // Disable the other dropdown
                document.getElementById('intervalHours').disabled = true;

                // Hide error since one option is selected
                document.getElementById('scheduleError').style.display = 'none';
            } else {
                // This checkbox was unchecked
                document.getElementById('dailyTime').disabled = true;

                // Check if both are now unchecked
                const intervalChecked = document.getElementById('intervalSchedule').checked;
                document.getElementById('scheduleError').style.display = (!intervalChecked) ? 'block' : 'none';
            }
        });

        document.getElementById('intervalSchedule').addEventListener('change', function() {
            // If this checkbox is now checked
            if (this.checked) {
                // Enable its dropdown
                document.getElementById('intervalHours').disabled = false;

                // Uncheck the other option
                document.getElementById('dailySchedule').checked = false;
                // Disable the other dropdown
                document.getElementById('dailyTime').disabled = true;

                // Hide error since one option is selected
                document.getElementById('scheduleError').style.display = 'none';
            } else {
                // This checkbox was unchecked
                document.getElementById('intervalHours').disabled = true;

                // Check if both are now unchecked
                const dailyChecked = document.getElementById('dailySchedule').checked;
                document.getElementById('scheduleError').style.display = (!dailyChecked) ? 'block' : 'none';
            }
        });
        
        // Script selection changes
        document.getElementById('scriptSelect').addEventListener('change', function() {
            setupParameterInputs(this.value);
        });
        
        // Save button
        document.getElementById('saveScheduleBtn').addEventListener('click', saveSchedule);
        
        // Run now button in view modal
        document.getElementById('runNowBtn').addEventListener('click', function() {
            if (currentScheduleId) {
                runScheduleNow(currentScheduleId);
                
                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('viewScheduleModal'));
                modal.hide();
            }
        });
        
        // Reset form when modal is closed
        document.getElementById('addScheduleModal').addEventListener('hidden.bs.modal', resetScheduleForm);
    });

    function populateTimeOptions() {
        const select = document.getElementById('dailyTime');
        
        // Clear existing options
        select.innerHTML = '';
        
        // Create 30-minute intervals for the entire day
        for (let hour = 0; hour < 24; hour++) {
            for (let minute of [0, 30]) {
                // Create value in HH:MM format (24-hour format)
                const value = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                
                // Create display text (12-hour format with AM/PM)
                let hour12 = hour % 12;
                if (hour12 === 0) hour12 = 12;
                const period = hour < 12 ? 'AM' : 'PM';
                const text = `${hour12}:${minute.toString().padStart(2, '0')} ${period}`;
                
                // Create option element
                const option = document.createElement('option');
                option.value = value;
                option.textContent = text;
                
                // Select 10:00 AM by default
                if (hour === 10 && minute === 0) {
                    option.selected = true;
                }
                
                // Add option to dropdown list
                select.appendChild(option);
            }
        }
    }

    /**
     * Creates options for run intervals
     */
    function populateIntervalOptions() {
        const select = document.getElementById('intervalHours');
        
        // Clear existing options
        select.innerHTML = '';
        
        // Add only allowed intervals with hour values
        const allowedIntervals = [
            {value: "1", text: "1 hour"},
            {value: "2", text: "2 hours"},
            {value: "3", text: "3 hours"},
            {value: "4", text: "4 hours"},
            {value: "6", text: "6 hours"},
            {value: "8", text: "8 hours"},
            {value: "12", text: "12 hours"},
            {value: "24", text: "24 hours"}
        ];
        
        allowedIntervals.forEach(interval => {
            const option = document.createElement('option');
            option.value = interval.value;
            option.textContent = interval.text;
            
            // Select 12 hours by default
            if (interval.value === "12") {
                option.selected = true;
            }
            
            select.appendChild(option);
        });
    }
</script>
{% endblock %}